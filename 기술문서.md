# 연구비 예산관리 시스템 기술문서

## 1. 시스템 개요

### 1.1 목적
외부 ERP 파일 없이, 프로그램 화면에서 연구비 지출내역을 직접 입력·수정하고, 저장된 엑셀 파일을 다시 읽어와 예산 집계·관리를 반복 수행할 수 있는 경량 연구비 예산관리 도구를 개발한다.

### 1.2 핵심 특징
- **로컬 실행형**: 외부 서버 의존 없이 로컬 PC에서 독립 실행
- **엑셀 기반 저장**: 모든 데이터를 단일 마스터 엑셀 파일로 관리
- **이중 집계 체계**: ERP 통계목 기준과 RCMS 기준으로 이중 집계 지원
- **직관적 UI**: Streamlit 기반 웹 인터페이스로 쉬운 데이터 입력/수정

### 1.3 주요 기능
1. **다중 과제 관리**: 각 과제별로 독립적인 예산 관리 (과제별 작업 폴더)
2. 지출내역 입력/수정 (프로그램 화면에서 직접 입력)
3. 예산 집계 (ERP 통계목 기준 / RCMS 기준)
4. 저장 (엑셀 마스터 파일로 저장)
5. 불러오기 (기존 마스터 파일을 다시 읽어와 이어서 작업)
6. 초기 예산 설정 (사용자가 직접 입력/수정하는 실행예산 관리)

## 2. 기능 요구사항

### 2.1 지출내역 관리 기능

#### 2.1.1 기본 입력 필드
| 필드명 | 타입 | 필수 | 설명 | 예시 |
|--------|------|------|------|------|
| id | Integer | 자동 | 내부용 고유 ID (자동 증가) | 1, 2, 3, ... |
| 통계목명 | String | 필수 | ERP 통계목 분류 | 상용임금, 일반수용비, 국내여비 등 |
| 사용일자 | Date | 필수 | yyyy-mm-dd 형식 | 2025-01-20 |
| 지출결의명 | String | 필수 | 지출 건명 | "2025년 1월 급여", "법인카드 정산(국민카드[2881])" |
| 상세내역 | String | 선택 | 카드 상세 품목, 메모 등 | "점심식사(○○), 대중교통, 간식…" |
| 지출결의액 | Integer | 필수 | 금액 (원 단위, 정수) | 8255320, 50000 |

#### 2.1.2 RCMS 분류 필드
| 필드명 | 타입 | 필수 | 설명 |
|--------|------|------|------|
| rcms_code | String | 선택 | RCMS 분류 코드 |
| rcms_name | String | 자동 | RCMS 항목명 (rcms_code 선택 시 자동 채움) |
| rcms_settled | Boolean | 선택 | 정산 완료 여부 (기본값: False) |

#### 2.1.3 기능 요구사항
- **행 추가**: 새 지출내역 행 추가 (id 자동 할당)
- **행 수정**: 기존 행의 모든 필드 수정 가능
- **행 삭제**: 선택한 행 삭제 (확인 다이얼로그)
- **일괄 수정**: 여러 행 선택하여 일괄 수정 가능
- **복사/붙여넣기**: 행 복사 및 붙여넣기 기능
- **검색/필터**: 통계목명, 지출결의명, 사용일자 범위 등으로 필터링
- **정렬**: 컬럼별 오름차순/내림차순 정렬

#### 2.1.4 데이터 검증 규칙
- **통계목명**: ERP_BUDGET 시트에 존재하는 통계목만 허용 (드롭다운)
- **사용일자**: 유효한 날짜 형식 검증 (yyyy-mm-dd)
- **지출결의액**: 0 이상의 정수만 허용
- **rcms_code**: RCMS_BUDGET 시트에 존재하는 코드만 허용 (드롭다운)
- **필수 필드**: 통계목명, 사용일자, 지출결의명, 지출결의액은 필수 입력

### 2.2 예산 집계 기능

#### 2.2.1 ERP 기준 집계
**집계 기준**: 통계목명별 지출결의액 합산

**계산 항목**:
- 집행액 = EXPENSE 시트에서 통계목명별 지출결의액 합계
- 잔액 = 실행예산 - 집행액
- 집행률(%) = (집행액 / 실행예산) × 100

**주의사항**:
- 실행예산이 0인 경우 집행률 계산 시 "N/A" 또는 0%로 표시
- 실행예산이 입력되지 않은 항목은 경고 표시

**출력 형식**:
| 통계목명 | 실행예산 | 집행액 | 잔액 | 집행률(%) |
|----------|----------|--------|------|-----------|

**시각화**:
- 통계목별 집행률 바 차트
- 잔액이 음수인 항목 경고 표시 (빨간색)
- 집행률 80% 이상 항목 주의 표시 (노란색)

#### 2.2.2 RCMS 기준 집계
**집계 기준**: rcms_code별 지출결의액 합산

**계산 항목**:
- used_amount = EXPENSE 시트에서 rcms_code별 지출결의액 합계
- balance = budget_amount - used_amount
- rate(%) = (used_amount / budget_amount) × 100

**미정산 금액 계산**:
- rcms_settled = False인 행만 필터링하여 별도 집계
- "RCMS 미정산 금액" 별도 표시

**출력 형식**:
| rcms_code | rcms_name | budget_amount | used_amount | balance | rate(%) | 미정산금액 |
|-----------|-----------|---------------|-------------|---------|---------|------------|

**시각화**:
- RCMS 항목별 집행률 바 차트
- 미정산 금액 별도 섹션 표시
- 정산 완료/미완료 필터 옵션

#### 2.2.3 집계 실행 시점
- **수동 집계**: "집계 실행" 버튼 클릭 시
- **자동 집계**: 데이터 저장 시 자동 실행
- **실시간 집계**: 데이터 입력/수정 시 실시간 업데이트 (선택 옵션)

### 2.3 저장 및 불러오기 기능

#### 2.3.1 저장 기능
**저장 대상**:
- EXPENSE 시트: 모든 지출내역 데이터
- ERP_BUDGET 시트: 예산 정보 및 집계 결과
- RCMS_BUDGET 시트: 예산 정보 및 집계 결과
- MAPPING_ERP_RCMS 시트: ERP-RCMS 매핑 정보

**저장 방식**:
- 전체 덮어쓰기: 기존 master.xlsx 파일을 완전히 덮어씀
- 백업 생성: 저장 전 기존 파일을 `master_backup_YYYYMMDD_HHMMSS.xlsx`로 백업
- 저장 위치: config.json에 지정된 작업 폴더 내 master.xlsx

**저장 시 검증**:
- 필수 필드 누락 검사
- 데이터 타입 검증
- 중복 id 검사
- 파일 쓰기 권한 확인

#### 2.3.2 불러오기 기능
**불러오기 시점**:
- 프로그램 시작 시 자동 불러오기
- "불러오기" 버튼으로 수동 불러오기

**불러오기 프로세스**:
1. config.json에서 작업 폴더 경로 확인
2. master.xlsx 파일 존재 여부 확인
3. 파일 읽기 및 각 시트 로드
4. 데이터 검증 및 오류 처리
5. 메모리 상 DataFrame에 로드

**오류 처리**:
- 파일이 없을 경우: 빈 구조 생성 안내
- 파일 손상 시: 백업 파일 자동 복구 시도
- 데이터 형식 오류: 오류 행 표시 및 수정 안내

#### 2.3.3 자동 저장 기능 (선택)
- 일정 시간 간격 자동 저장 (예: 5분마다)
- 변경 사항 감지 시 자동 저장 옵션
- 자동 저장 여부는 설정에서 제어

### 2.4 예산 관리 기능

#### 2.4.1 ERP 예산 입력/수정
- **초기 설정**: 프로그램 최초 실행 시 ERP 통계목 목록이 자동 생성되며, 실행예산은 빈 값으로 시작
- **예산 입력**: 사용자가 ERP 예산 현황 화면에서 각 통계목별 실행예산을 직접 입력
- **예산 수정**: 언제든지 실행예산을 수정할 수 있으며, 수정 후 집계를 다시 실행하면 새로운 기준으로 계산됨
- **검증**: 실행예산은 0 이상의 정수만 허용

#### 2.4.2 RCMS 예산 입력/수정
- **초기 설정**: 프로그램 최초 실행 시 RCMS 세부항목 목록이 자동 생성되며, budget_amount는 빈 값으로 시작
- **예산 입력**: 사용자가 RCMS 예산 현황 화면에서 각 세부항목별 예산을 직접 입력
- **예산 수정**: 언제든지 budget_amount를 수정할 수 있으며, 수정 후 집계를 다시 실행하면 새로운 기준으로 계산됨
- **검증**: budget_amount는 0 이상의 정수만 허용

### 2.5 추가 기능

#### 2.5.1 데이터 검색 및 필터
- **통계목명 필터**: 드롭다운으로 특정 통계목만 표시
- **날짜 범위 필터**: 시작일-종료일 지정하여 기간별 조회
- **지출결의명 검색**: 키워드 검색
- **RCMS 정산 상태 필터**: 정산 완료/미완료 필터
- **금액 범위 필터**: 최소/최대 금액 지정

#### 2.5.2 데이터 내보내기
- **엑셀 내보내기**: 현재 화면 데이터를 별도 엑셀 파일로 저장
- **PDF 리포트**: 예산 현황 리포트 PDF 생성
- **CSV 내보내기**: 데이터 교환용 CSV 파일 생성

#### 2.5.3 통계 및 분석
- **월별 집행 추이**: 월별 집행액 추이 그래프
- **통계목별 비중**: 파이 차트로 통계목별 비중 표시
- **예산 대비 집행률**: 전체 예산 대비 집행률 대시보드

## 3. 파일 및 데이터 구조

### 3.1 작업 폴더 구조
```
사용자가 선택한 폴더/
├── master.xlsx              # 핵심 데이터 파일
├── master_backup_*.xlsx     # 자동 백업 파일들
└── export/                  # 보고용 출력 파일 (선택)
    ├── report_YYYYMMDD.xlsx
    └── report_YYYYMMDD.pdf
```

**유연한 폴더 구조**: 
- 사용자가 원하는 위치에 과제별 폴더를 생성하고 관리할 수 있습니다.
- 각 과제는 독립적인 폴더와 master.xlsx 파일로 관리됩니다.
- 프로그램은 특정 폴더 구조를 강제하지 않으며, 사용자가 선택한 폴더 내에서만 동작합니다.
- 예시: `D:\RND_Budget\2025_과제A\`, `C:\Projects\연구과제B\` 등 자유롭게 구성 가능

### 3.2 config.json 구조
```json
{
  "last_work_folder": "D:\\RND_Budget\\2025_과제A",
  "auto_save": false,
  "auto_save_interval": 300,
  "backup_count": 10,
  "date_format": "YYYY-MM-DD",
  "currency_format": "ko_KR"
}
```

**설정 파일 특징**:
- **last_work_folder**: 마지막으로 사용한 작업 폴더 경로 (선택적, 편의를 위한 기본값 제안용)
- 프로그램 실행 시 이 경로를 기본값으로 제안하지만, 사용자가 언제든지 다른 폴더를 선택할 수 있습니다.
- 프로젝트 목록을 저장하지 않으며, 매번 UI에서 직접 폴더/파일을 선택합니다.
- 다른 설정들은 프로그램 전역 설정으로 유지됩니다.

### 3.3 master.xlsx 시트 구성

#### 3.3.1 EXPENSE 시트
| 컬럼명 | 데이터 타입 | 설명 | 예시 |
|--------|------------|------|------|
| id | Integer | 고유 ID (자동 증가) | 1, 2, 3, ... |
| 통계목명 | String | ERP 통계목 분류 | 상용임금 |
| 사용일자 | Date | 지출 발생일 | 2025-01-20 |
| 지출결의명 | String | 지출 건명 | 2025년 1월 급여 |
| 상세내역 | String | 상세 설명 | 점심식사, 대중교통 |
| 지출결의액 | Integer | 금액 (원) | 8255320 |
| rcms_code | String | RCMS 분류 코드 | R001 |
| rcms_name | String | RCMS 항목명 | 인건비 |
| rcms_settled | Boolean | 정산 완료 여부 | TRUE/FALSE |
| created_at | DateTime | 생성 일시 | 2025-01-20 10:30:00 |
| updated_at | DateTime | 수정 일시 | 2025-01-20 15:45:00 |

#### 3.3.2 ERP_BUDGET 시트
| 컬럼명 | 데이터 타입 | 설명 | 예시 |
|--------|------------|------|------|
| 통계목명 | String | ERP 통계목 분류 | 상용임금 |
| 실행예산 | Integer | 예산 금액 (원, 사용자 입력) | 109117462 |
| 집행액 | Integer | 집행 금액 (계산) | 99355510 |
| 잔액 | Integer | 잔액 (계산) | 9761952 |
| 집행률 | Float | 집행률 % (계산) | 91.05 |
| updated_at | DateTime | 마지막 업데이트 | 2025-01-20 15:45:00 |

**초기 데이터**: 프로그램 최초 실행 시 다음 ERP 통계목 목록이 자동으로 생성됩니다.
- 총액
- 기타직보수
- 상용임금
- 일반수용비
- 임차료
- 유류비
- 재료비
- 국내여비
- 국외업무여비
- 사업추진비
- 자산취득비
- 무형자산
- 일반관리비
- 고용부담금

**실행예산 입력**: 사용자가 각 통계목별로 실행예산을 직접 입력하거나 수정할 수 있으며, 이 값이 집계의 기준이 됩니다.

#### 3.3.3 RCMS_BUDGET 시트
| 컬럼명 | 데이터 타입 | 설명 | 예시 |
|--------|------------|------|------|
| rcms_code | String | RCMS 분류 코드 (세부항목 기준) | RCMS_001 |
| rcms_name | String | RCMS 항목명 (세부항목명) | 연구근접지원인건비 |
| parent_category | String | 상위 항목명 | 인건비 |
| budget_amount | Integer | 예산 금액 (원, 사용자 입력) | 50000000 |
| used_amount | Integer | 사용 금액 (계산) | 45000000 |
| balance | Integer | 잔액 (계산) | 5000000 |
| rate | Float | 집행률 % (계산) | 90.00 |
| updated_at | DateTime | 마지막 업데이트 | 2025-01-20 15:45:00 |

**초기 데이터**: 프로그램 최초 실행 시 다음 RCMS 항목 구조가 자동으로 생성됩니다.

**인건비 (Personnel Expenses)**
- 연구근접지원인건비
- 참여연구원인건비

**연구시설장비비 (Research Facility & Equipment Expenses)**
- 연구시설장비임차비
- 연구시설장비구입설치비
- 연구시설장비운영유지비
- 연구인프라조성비

**연구재료비 (Research Material Expenses)**
- 연구개발과제관리비
- 연구재료구입비
- 연구재료제작비

**연구활동비 (Research Activity Expenses)**
- 소프트웨어활용비
- 연구실운영비
- 연구인력지원비
- 연구활동비기타비용
- 외부전문기술활용비
- 종합사업관리비
- 지식재산창출활동비
- 출장비
- 클라우드컴퓨팅서비스활용비
- 해외연구자유치지원비
- 회의비

**연구수당 (Research Allowance)**
- 연구수당

**간접비 (Indirect Expenses)**
- 간접비

**실행예산 입력**: 사용자가 각 RCMS 세부항목별로 예산을 직접 입력하거나 수정할 수 있으며, 이 값이 집계의 기준이 됩니다.

**코드 체계**: rcms_code는 세부항목 기준으로 생성되며, 예를 들어 "연구근접지원인건비"는 "RCMS_001"과 같은 형식으로 자동 할당됩니다.

**코드 할당 규칙**:
- 인건비 계열: RCMS_001 ~ RCMS_002
- 연구시설장비비 계열: RCMS_003 ~ RCMS_006
- 연구재료비 계열: RCMS_007 ~ RCMS_009
- 연구활동비 계열: RCMS_010 ~ RCMS_021
- 연구수당: RCMS_022
- 간접비: RCMS_023

코드는 항목 생성 순서에 따라 자동 할당되며, 사용자가 직접 수정할 필요는 없습니다.

#### 3.3.4 MAPPING_ERP_RCMS 시트
| 컬럼명 | 데이터 타입 | 설명 | 예시 |
|--------|------------|------|------|
| ERP_통계목명 | String | ERP 통계목 | 상용임금 |
| rcms_code | String | 기본 RCMS 코드 | RCMS_001 |
| rcms_name | String | RCMS 항목명 | 연구근접지원인건비 |
| priority | Integer | 우선순위 (1=최우선) | 1 |

**용도**: 지출내역 입력 시 통계목명을 선택하면, 이 매핑 테이블을 참조하여 기본 RCMS 코드를 자동 제안합니다. 사용자는 나중에 수정할 수 있습니다.

**초기 매핑 예시** (사용자가 필요에 따라 수정 가능):
- 상용임금 → 연구근접지원인건비 (RCMS_001)
- 국내여비 → 출장비 (RCMS_017)
- 일반수용비 → 연구실운영비 (RCMS_011)
- 등등...

## 4. 프로그램 동작 흐름

### 4.0 초기 데이터 생성 로직

#### 4.0.1 ERP_BUDGET 초기화
프로그램이 새 프로젝트를 생성하거나 master.xlsx가 없을 때:

1. **ERP 통계목 목록 생성**: 14개 통계목을 자동으로 생성
   - 각 행의 "통계목명" 컬럼에 통계목명 입력
   - "실행예산" 컬럼은 빈 값(0 또는 NULL)으로 시작
   - "집행액", "잔액", "집행률"은 계산 필드이므로 빈 값
   - "updated_at"은 현재 시간으로 설정

2. **사용자 작업**: 사용자가 각 통계목의 "실행예산"을 직접 입력

#### 4.0.2 RCMS_BUDGET 초기화
프로그램이 새 프로젝트를 생성하거나 master.xlsx가 없을 때:

1. **RCMS 세부항목 목록 생성**: 23개 세부항목을 자동으로 생성
   - 각 행의 "rcms_name" 컬럼에 세부항목명 입력
   - "parent_category" 컬럼에 상위 항목명 입력 (인건비, 연구시설장비비 등)
   - "rcms_code" 컬럼에 자동 할당된 코드 입력 (RCMS_001 ~ RCMS_023)
   - "budget_amount" 컬럼은 빈 값(0 또는 NULL)으로 시작
   - "used_amount", "balance", "rate"는 계산 필드이므로 빈 값
   - "updated_at"은 현재 시간으로 설정

2. **사용자 작업**: 사용자가 각 세부항목의 "budget_amount"를 직접 입력

#### 4.0.3 초기화 시점
- **새 프로젝트 생성 시**: 사용자가 선택한 폴더에 master.xlsx 생성 및 초기화
- **기존 폴더 선택 시 master.xlsx가 없을 때**: 해당 폴더에 master.xlsx 생성 및 초기화
- **기존 master.xlsx 파일 열기 시**: 기존 데이터를 로드하고 초기화하지 않음

### 4.1 프로그램 초기 실행
```
1. config.json 읽기
   ├─ 파일 없음 → 기본 설정으로 생성
   └─ 파일 있음 → 설정 로드 (last_work_folder 확인)

2. 작업 폴더/파일 선택 화면 표시
   ├─ 파일 선택 방식 제공
   │   ├─ [기존 파일 열기] 버튼: master.xlsx 파일 직접 선택
   │   ├─ [폴더 선택] 버튼: 작업 폴더 선택 후 해당 폴더의 master.xlsx 사용
   │   └─ [새 프로젝트] 버튼: 새 폴더 선택 후 master.xlsx 생성
   ├─ last_work_folder가 있으면 기본값으로 제안
   └─ 사용자가 원하는 방식으로 선택

3. master.xlsx 확인 및 처리
   ├─ 파일 없음 (새 프로젝트) → 초기 구조 생성
   │   ├─ 사용자가 선택한 폴더에 master.xlsx 생성
   │   ├─ EXPENSE 시트 생성 (헤더만)
   │   ├─ ERP_BUDGET 시트 생성
   │   │   ├─ ERP 통계목 목록 자동 생성 (14개 항목)
   │   │   └─ 실행예산 컬럼은 빈 값 (사용자 입력 대기)
   │   ├─ RCMS_BUDGET 시트 생성
   │   │   ├─ RCMS 세부항목 목록 자동 생성 (전체 항목)
   │   │   ├─ rcms_code 자동 할당
   │   │   └─ budget_amount 컬럼은 빈 값 (사용자 입력 대기)
   │   └─ MAPPING_ERP_RCMS 시트 생성 (빈 구조)
   └─ 파일 있음 → 데이터 로드
       ├─ 각 시트 읽기
       ├─ 데이터 검증
       └─ DataFrame에 로드

4. UI 초기화 및 표시
   ├─ 현재 작업 폴더 경로 표시
   ├─ master.xlsx 파일 경로 표시
   └─ 메인 메뉴 표시
```

### 4.2 지출내역 입력/수정 흐름
```
1. 지출내역 관리 화면 진입

2. 데이터 표시
   ├─ 기존 데이터 테이블 표시
   └─ 필터/검색 옵션 표시

3. 사용자 작업
   ├─ 새 행 추가
   │   ├─ 기본값 자동 입력 (통계목명 → rcms_code 매핑)
   │   └─ 사용자 입력
   ├─ 기존 행 수정
   │   └─ 셀 편집
   ├─ 행 삭제
   │   └─ 확인 후 삭제
   └─ 일괄 작업
       ├─ 여러 행 선택
       └─ 일괄 수정/삭제

4. 데이터 검증
   ├─ 필수 필드 확인
   ├─ 데이터 타입 검증
   └─ 비즈니스 규칙 검증

5. 메모리 업데이트
   └─ DataFrame 즉시 반영

6. 저장
   └─ "저장" 버튼 클릭 시 master.xlsx에 기록
```

### 4.3 예산 집계 처리 흐름
```
1. 집계 실행 요청

2. ERP 기준 집계
   ├─ EXPENSE에서 통계목명별 합계 계산
   ├─ ERP_BUDGET과 조인
   ├─ 집행액, 잔액, 집행률 계산
   └─ 결과를 ERP_BUDGET 시트에 업데이트

3. RCMS 기준 집계
   ├─ EXPENSE에서 rcms_code별 합계 계산
   ├─ RCMS_BUDGET과 조인
   ├─ used_amount, balance, rate 계산
   ├─ 미정산 금액 별도 계산
   └─ 결과를 RCMS_BUDGET 시트에 업데이트

4. 결과 표시
   ├─ 테이블 형태로 표시
   ├─ 차트/그래프 생성
   └─ 경고/주의 항목 하이라이트
```

### 4.4 저장/불러오기 사이클
```
저장 사이클:
1. 사용자 입력/수정
2. "저장" 버튼 클릭
3. 현재 작업 중인 master.xlsx 파일 경로 확인
4. 백업 생성 (기존 master.xlsx → master_backup_*.xlsx)
5. 각 시트 데이터를 master.xlsx에 저장
6. config.json의 last_work_folder 업데이트 (현재 파일의 폴더 경로)
7. 저장 완료 메시지

불러오기 사이클:
1. 프로그램 시작 또는 "파일 변경" 버튼 클릭
2. 파일 선택 화면 표시
3. 사용자가 master.xlsx 파일 또는 폴더 선택
4. master.xlsx 파일 경로 확인
   ├─ 파일 없음 → 초기 구조 생성
   └─ 파일 있음 → 다음 단계
5. 각 시트 읽기
6. 데이터 검증
7. DataFrame에 로드
8. UI에 표시
9. config.json의 last_work_folder 업데이트

파일 변경 사이클:
1. "파일 변경" 버튼 클릭
2. 현재 작업 내용이 저장되지 않았다면 저장 확인
3. 파일 선택 화면 표시
4. 사용자가 다른 master.xlsx 파일 선택
5. 불러오기 사이클 실행
```

## 5. UI 설계 (Streamlit)

### 5.1 메인 레이아웃
```
┌─────────────────────────────────────────┐
│  연구비 예산관리 시스템                  │
├─────────────────────────────────────────┤
│ 현재 파일: D:\RND_Budget\2025_과제A\    │
│          master.xlsx                    │
│ [파일 변경] [폴더 열기]                  │
├─────────────────────────────────────────┤
│ [지출내역 관리] [ERP 예산] [RCMS 예산]  │
│ [설정] [도움말]                          │
├─────────────────────────────────────────┤
│                                         │
│  (선택된 메뉴 화면)                      │
│                                         │
└─────────────────────────────────────────┘
```

**파일 관리**: 
- 상단에 현재 작업 중인 master.xlsx 파일 경로가 표시됩니다.
- "파일 변경" 버튼을 클릭하면 다른 master.xlsx 파일을 선택할 수 있습니다.
- "폴더 열기" 버튼으로 현재 작업 폴더를 파일 탐색기에서 열 수 있습니다.

### 5.1.1 파일 선택 화면 (프로그램 시작 시 또는 파일 변경 시)
```
┌─────────────────────────────────────────┐
│  작업 파일 선택                           │
├─────────────────────────────────────────┤
│  작업 방식을 선택하세요:                  │
│                                          │
│  [기존 파일 열기]                         │
│  → master.xlsx 파일을 직접 선택          │
│                                          │
│  [폴더 선택]                              │
│  → 작업 폴더를 선택하면 해당 폴더의      │
│    master.xlsx를 사용 (없으면 생성)       │
│                                          │
│  [새 프로젝트]                            │
│  → 새 폴더를 선택하고 master.xlsx 생성    │
├─────────────────────────────────────────┤
│  최근 사용한 폴더:                        │
│  D:\RND_Budget\2025_과제A [선택]         │
│  C:\Projects\연구과제B [선택]            │
└─────────────────────────────────────────┘
```

**파일 선택 방식**:
- **기존 파일 열기**: 파일 다이얼로그를 통해 master.xlsx 파일을 직접 선택
- **폴더 선택**: 폴더를 선택하면 해당 폴더 내의 master.xlsx를 사용 (없으면 새로 생성)
- **새 프로젝트**: 새 폴더를 선택하고 master.xlsx를 생성
- **최근 폴더**: config.json의 last_work_folder를 기반으로 최근 사용한 폴더를 빠르게 선택할 수 있는 버튼 제공

### 5.2 지출내역 관리 화면
```
┌─────────────────────────────────────────┐
│  지출내역 관리                           │
├─────────────────────────────────────────┤
│  [검색/필터]                             │
│  통계목명: [드롭다운▼]                   │
│  날짜 범위: [시작일] ~ [종료일]          │
│  지출결의명: [검색어 입력]               │
│  [검색] [초기화]                         │
├─────────────────────────────────────────┤
│  [새 행 추가] [선택 삭제] [일괄 수정]    │
├─────────────────────────────────────────┤
│  데이터 테이블 (편집 가능)                │
│  id | 통계목명 | 사용일자 | ...          │
│  1  | 상용임금 | 2025-01-20 | ...        │
│  2  | 일반수용비 | 2025-05-07 | ...      │
│  ...                                     │
├─────────────────────────────────────────┤
│  [저장] [불러오기] [내보내기]            │
│  총 행 수: 150 | 총 금액: 363,988,875원  │
└─────────────────────────────────────────┘
```

### 5.3 ERP 예산 현황 화면
```
┌─────────────────────────────────────────┐
│  ERP 예산 현황                           │
├─────────────────────────────────────────┤
│  [집계 실행] [예산 수정] [새로고침]      │
├─────────────────────────────────────────┤
│  통계목별 집행 현황 (편집 가능)           │
│  ┌───────────────────────────────────┐ │
│  │ 통계목명 | 실행예산 | 집행액 | 잔액│ │
│  │ 상용임금 | [109117462] | ... | ...│ │
│  │ 일반수용비 | [12388935] | ... | ...│ │
│  └───────────────────────────────────┘ │
│  ※ 실행예산은 직접 수정 가능              │
├─────────────────────────────────────────┤
│  집행률 차트                             │
│  [바 차트 표시]                          │
├─────────────────────────────────────────┤
│  요약 정보                               │
│  총 예산: 451,153,309원                  │
│  총 집행액: 363,988,875원                │
│  총 잔액: 87,164,434원                   │
│  평균 집행률: 80.7%                      │
└─────────────────────────────────────────┘
```

**예산 수정**: "예산 수정" 버튼을 클릭하면 실행예산 컬럼이 편집 가능한 상태가 되어 사용자가 직접 수정할 수 있습니다.

### 5.4 RCMS 예산 현황 화면
```
┌─────────────────────────────────────────┐
│  RCMS 예산 현황                           │
├─────────────────────────────────────────┤
│  [집계 실행] [예산 수정] [정산 상태 필터▼]│
│  [새로고침]                               │
├─────────────────────────────────────────┤
│  RCMS 항목별 집행 현황 (편집 가능)        │
│  ┌───────────────────────────────────┐ │
│  │ 코드 | 항목명 | 예산 | 사용액 | ...│ │
│  │ RCMS_001 | 연구근접지원인건비 | ...│ │
│  │ [50000000] | ... | ... | ...     │ │
│  └───────────────────────────────────┘ │
│  ※ 예산(budget_amount)은 직접 수정 가능   │
├─────────────────────────────────────────┤
│  미정산 금액                             │
│  총 미정산 금액: 50,000,000원            │
│  미정산 건수: 25건                       │
├─────────────────────────────────────────┤
│  집행률 차트                             │
│  [바 차트 표시]                          │
└─────────────────────────────────────────┘
```

**예산 수정**: "예산 수정" 버튼을 클릭하면 budget_amount 컬럼이 편집 가능한 상태가 되어 사용자가 각 RCMS 세부항목별 예산을 직접 수정할 수 있습니다.

### 5.5 설정 화면
```
┌─────────────────────────────────────────┐
│  설정                                    │
├─────────────────────────────────────────┤
│  현재 작업 파일                          │
│  경로: D:\RND_Budget\2025_과제A\        │
│       master.xlsx                        │
│  [파일 변경] [폴더 열기]                 │
├─────────────────────────────────────────┤
│  자동 저장                               │
│  ☑ 자동 저장 사용                        │
│  간격: [5] 분                            │
├─────────────────────────────────────────┤
│  백업 설정                               │
│  백업 파일 보관 개수: [10] 개             │
├─────────────────────────────────────────┤
│  데이터 형식                             │
│  날짜 형식: [YYYY-MM-DD]                 │
│  통화 형식: [한국어 (원)]                │
├─────────────────────────────────────────┤
│  [설정 저장] [기본값 복원]                │
└─────────────────────────────────────────┘
```

**설정 특징**:
- 프로젝트 목록을 관리하지 않으며, 현재 작업 파일 정보만 표시합니다.
- "파일 변경" 버튼으로 언제든지 다른 master.xlsx 파일을 선택할 수 있습니다.
- 설정 저장 시 last_work_folder만 업데이트됩니다 (편의를 위한 기본값 제안용).

## 6. 기술 스택 및 아키텍처

### 6.1 개발 환경
| 항목 | 내용 |
|------|------|
| Python | 3.10 이상 |
| 주요 라이브러리 | pandas, openpyxl, streamlit, plotly |
| 저장 포맷 | Excel (xlsx) |
| 동작 방식 | 로컬 PC에서 streamlit run 실행 후 브라우저 접속 |

### 6.2 프로젝트 구조
```
rnd_monitor/
├── app.py                  # Streamlit 메인 애플리케이션
├── config.py               # 설정 관리 모듈
├── data_manager.py         # 데이터 로드/저장 관리
├── expense_manager.py      # 지출내역 관리 로직
├── budget_calculator.py    # 예산 집계 계산 로직
├── initial_data.py         # 초기 데이터 생성 모듈
├── ui_components.py        # 재사용 가능한 UI 컴포넌트
├── validators.py           # 데이터 검증 로직
├── utils.py                # 유틸리티 함수
├── requirements.txt        # 패키지 의존성
├── README.md               # 사용자 가이드
└── tests/                  # 테스트 코드
    ├── test_data_manager.py
    ├── test_budget_calculator.py
    ├── test_validators.py
    └── test_initial_data.py
```

### 6.3 모듈별 책임

#### 6.3.1 app.py
- Streamlit 애플리케이션 진입점
- 페이지 라우팅 및 메뉴 구성
- 전역 상태 관리

#### 6.3.2 config.py
- config.json 읽기/쓰기
- 설정 값 검증 및 기본값 제공
- last_work_folder 관리 (최근 사용한 폴더 경로만 저장)

#### 6.3.3 data_manager.py
- master.xlsx 파일 읽기/쓰기
- 각 시트별 데이터 로드/저장
- 백업 파일 관리
- 데이터 무결성 검증

#### 6.3.4 expense_manager.py
- 지출내역 CRUD 작업
- 데이터 필터링 및 검색
- ERP-RCMS 매핑 자동 제안

#### 6.3.5 budget_calculator.py
- ERP 기준 집계 계산
- RCMS 기준 집계 계산
- 집행률, 잔액 계산
- 미정산 금액 계산

#### 6.3.6 ui_components.py
- 재사용 가능한 Streamlit 컴포넌트
- 데이터 테이블 표시 컴포넌트
- 차트/그래프 컴포넌트

#### 6.3.7 validators.py
- 입력 데이터 검증
- 날짜 형식 검증
- 금액 형식 검증
- 필수 필드 검증

#### 6.3.8 utils.py
- 날짜 포맷 변환
- 금액 포맷 변환
- 파일 경로 유틸리티
- 로깅 유틸리티

#### 6.3.9 initial_data.py (신규)
- ERP 통계목 초기 데이터 생성
- RCMS 세부항목 초기 데이터 생성
- RCMS 코드 자동 할당 로직
- 초기 master.xlsx 구조 생성

## 7. 에러 처리 및 예외 상황

### 7.1 파일 관련 에러
- **파일 없음**: 빈 구조 생성 안내 및 초기화 옵션 제공
- **파일 손상**: 백업 파일 자동 복구 시도, 실패 시 오류 메시지
- **파일 권한 오류**: 권한 확인 안내 및 해결 방법 제시
- **디스크 공간 부족**: 공간 부족 경고 및 대안 제시

### 7.2 데이터 관련 에러
- **데이터 형식 오류**: 오류 행 표시 및 수정 안내
- **필수 필드 누락**: 누락 필드 하이라이트 및 입력 요청
- **중복 ID**: 자동 ID 재할당 또는 사용자 확인
- **참조 무결성 오류**: 통계목명/rcms_code 존재 여부 확인

### 7.3 사용자 입력 에러
- **잘못된 날짜 형식**: 형식 안내 및 자동 변환 시도
- **음수 금액**: 경고 메시지 및 입력 차단
- **문자열 금액**: 숫자 변환 시도 또는 오류 메시지

### 7.4 집계 계산 에러
- **0으로 나누기**: 집행률 계산 시 예산이 0인 경우 처리
- **NULL 값 처리**: 누락된 데이터에 대한 기본값 적용
- **계산 오버플로우**: 큰 숫자 처리 시 정밀도 고려

## 8. 보안 고려사항

### 8.1 데이터 보안
- **로컬 저장**: 모든 데이터는 로컬 PC에만 저장 (서버 전송 없음)
- **파일 암호화**: 민감 정보 보호를 위한 옵션 (선택 사항)
- **접근 제어**: 파일 시스템 권한을 통한 접근 제어

### 8.2 입력 검증
- **SQL Injection 방지**: 엑셀 파일이므로 해당 없음
- **XSS 방지**: Streamlit 자동 이스케이프 처리
- **파일 경로 검증**: 상대 경로 공격 방지

### 8.3 백업 및 복구
- **자동 백업**: 저장 시 자동 백업 생성
- **백업 파일 관리**: 오래된 백업 자동 삭제
- **복구 기능**: 백업에서 복구하는 기능 제공

## 9. 성능 최적화

### 9.1 데이터 로딩
- **지연 로딩**: 필요한 시트만 선택적 로드
- **캐싱**: 자주 사용하는 데이터 메모리 캐싱
- **증분 로드**: 변경된 부분만 업데이트

### 9.2 집계 성능
- **인덱싱**: 통계목명, rcms_code에 대한 인덱스 활용
- **병렬 처리**: 대용량 데이터 시 병렬 집계 (선택)
- **결과 캐싱**: 집계 결과 캐싱하여 재계산 방지

### 9.3 UI 반응성
- **비동기 처리**: 집계 작업을 백그라운드에서 실행
- **진행 표시**: 장시간 작업 시 진행률 표시
- **페이지네이션**: 대용량 테이블의 페이지네이션

## 10. 테스트 전략

### 10.1 단위 테스트
- **데이터 검증**: validators.py 함수별 테스트
- **집계 계산**: budget_calculator.py 함수별 테스트
- **데이터 관리**: data_manager.py 함수별 테스트

### 10.2 통합 테스트
- **저장/불러오기**: 전체 데이터 저장 및 복원 테스트
- **집계 파이프라인**: 입력 → 집계 → 저장 전체 흐름 테스트
- **UI 상호작용**: 주요 사용자 시나리오 테스트

### 10.3 데이터 무결성 테스트
- **참조 무결성**: 통계목명, rcms_code 참조 검증
- **계산 정확성**: 집계 결과 수동 검증
- **데이터 손실**: 저장/불러오기 시 데이터 손실 검증

## 11. 배포 및 운영

### 11.1 배포 방법
- **로컬 설치**: requirements.txt를 통한 패키지 설치
- **실행 스크립트**: 배치 파일 또는 셸 스크립트로 실행 간소화
- **포터블 버전**: PyInstaller 등을 통한 실행 파일 생성 (선택)

### 11.2 사용자 가이드
- **초기 설정 가이드**: 작업 폴더 설정 방법
- **기능 사용 가이드**: 각 기능별 사용 방법
- **문제 해결 가이드**: 자주 발생하는 문제 및 해결 방법

### 11.3 업그레이드 및 마이그레이션
- **버전 관리**: master.xlsx 버전 정보 저장
- **데이터 마이그레이션**: 버전 업그레이드 시 데이터 마이그레이션 스크립트
- **하위 호환성**: 이전 버전 파일 읽기 지원

## 12. 향후 확장 계획

### 12.1 기능 확장
- **다중 프로젝트 관리**: 여러 프로젝트 동시 관리
- **사용자 권한 관리**: 다중 사용자 환경 지원
- **리포트 생성**: 다양한 형식의 리포트 자동 생성
- **알림 기능**: 예산 초과, 집행률 임계값 알림

### 12.2 데이터 연동
- **ERP 연동**: 외부 ERP 시스템과의 데이터 연동 (선택)
- **RCMS 연동**: RCMS 시스템과의 데이터 연동 (선택)
- **API 제공**: 다른 시스템과의 데이터 교환 API

### 12.3 분석 기능 강화
- **예측 분석**: 예산 소진 예측
- **트렌드 분석**: 월별/분기별 트렌드 분석
- **비교 분석**: 프로젝트 간 비교 분석

## 13. 추가 고려사항 및 개선 아이디어

### 13.1 데이터 검증 강화
- **비즈니스 규칙 검증**: 예산 초과 경고, 중복 지출 확인
- **이력 관리**: 데이터 변경 이력 추적 (감사 로그)
- **데이터 일관성**: ERP 예산과 RCMS 예산 간 일관성 검증

### 13.2 사용자 경험 개선
- **키보드 단축키**: 빠른 작업을 위한 단축키 지원
- **드래그 앤 드롭**: 파일 업로드 시 드래그 앤 드롭 지원
- **다크 모드**: 눈의 피로를 줄이기 위한 다크 모드
- **반응형 디자인**: 다양한 화면 크기 지원

### 13.3 성능 및 확장성
- **대용량 데이터 처리**: 수만 건 이상의 데이터 처리 최적화
- **데이터베이스 옵션**: SQLite 등 경량 DB 옵션 제공 (선택)
- **클라우드 저장**: 클라우드 스토리지 연동 옵션 (선택)

### 13.4 보고 및 시각화
- **대시보드**: 종합 대시보드 화면
- **인터랙티브 차트**: Plotly를 활용한 인터랙티브 차트
- **커스텀 리포트**: 사용자 정의 리포트 템플릿

### 13.5 데이터 품질 관리
- **중복 검사**: 동일 지출 건 중복 입력 방지
- **데이터 정리 도구**: 불완전한 데이터 정리 기능
- **데이터 검증 리포트**: 데이터 품질 리포트 생성

## 14. 구현 우선순위

### Phase 1: 핵심 기능 (MVP)
1. 프로젝트 선택 및 관리 (다중 과제 지원)
2. ERP/RCMS 초기 항목 목록 자동 생성
3. ERP/RCMS 예산 입력/수정 기능
4. 지출내역 입력/수정/삭제
5. ERP 기준 집계
6. RCMS 기준 집계
7. 저장/불러오기
8. 기본 UI 구성

### Phase 2: 사용성 개선
1. 검색/필터 기능
2. 데이터 검증 강화
3. 차트/그래프 시각화
4. 에러 처리 개선
5. 자동 백업

### Phase 3: 고급 기능
1. 리포트 생성
2. 통계 분석
3. 데이터 내보내기
4. 성능 최적화
5. 사용자 가이드

## 15. 참고 자료

### 15.1 초기 데이터 정의

#### 15.1.1 ERP 통계목 목록 (14개)
프로그램 최초 실행 시 다음 통계목이 ERP_BUDGET 시트에 자동 생성됩니다:
1. 총액
2. 기타직보수
3. 상용임금
4. 일반수용비
5. 임차료
6. 유류비
7. 재료비
8. 국내여비
9. 국외업무여비
10. 사업추진비
11. 자산취득비
12. 무형자산
13. 일반관리비
14. 고용부담금

#### 15.1.2 RCMS 세부항목 목록
프로그램 최초 실행 시 다음 RCMS 세부항목이 RCMS_BUDGET 시트에 자동 생성됩니다:

**인건비 (2개 세부항목)**
- 연구근접지원인건비
- 참여연구원인건비

**연구시설장비비 (4개 세부항목)**
- 연구시설장비임차비
- 연구시설장비구입설치비
- 연구시설장비운영유지비
- 연구인프라조성비

**연구재료비 (3개 세부항목)**
- 연구개발과제관리비
- 연구재료구입비
- 연구재료제작비

**연구활동비 (12개 세부항목)**
- 소프트웨어활용비
- 연구실운영비
- 연구인력지원비
- 연구활동비기타비용
- 외부전문기술활용비
- 종합사업관리비
- 지식재산창출활동비
- 출장비
- 클라우드컴퓨팅서비스활용비
- 해외연구자유치지원비
- 회의비

**연구수당 (1개 세부항목)**
- 연구수당

**간접비 (1개 세부항목)**
- 간접비

**총 23개 세부항목**

#### 15.1.3 RCMS 코드 체계
각 RCMS 세부항목에는 고유한 코드가 자동 할당됩니다:
- 형식: `RCMS_XXX` (XXX는 001부터 시작하는 순차 번호)
- 예시: 연구근접지원인건비 → `RCMS_001`
- 코드는 프로그램 내부에서 자동 관리되며, 사용자가 직접 수정할 필요 없음

### 15.2 관련 표준
- 연구개발비 회계 처리 기준
- RCMS 예산 항목 분류 체계
- ERP 통계목 분류 체계

---

**문서 버전**: 1.2  
**작성일**: 2025-01-20  
**최종 수정일**: 2025-01-20

## 16. 주요 변경사항

### 16.1 파일/폴더 선택 방식 개선 (v1.2)
- **UI 기반 파일 선택**: 프로그램 내에서 직접 파일/폴더 선택
- **경로 저장 최소화**: config.json에 last_work_folder만 저장 (편의를 위한 기본값 제안용)
- **유연한 폴더 구조**: 특정 폴더 구조를 강제하지 않음, 사용자가 원하는 위치에 파일 관리
- **파일 선택 옵션**: 기존 파일 열기 / 폴더 선택 / 새 프로젝트 생성 중 선택 가능

### 16.2 다중 과제 관리 기능 (v1.1)
- 각 과제별로 독립적인 작업 폴더와 master.xlsx 파일 관리
- UI에서 파일 변경 기능 제공
- 과제별 독립적인 예산 및 지출내역 관리

### 16.3 초기 데이터 자동 생성 (v1.1)
- ERP 통계목 목록 (14개) 자동 생성
- RCMS 세부항목 목록 (23개) 자동 생성
- RCMS 코드 자동 할당 체계

### 16.4 예산 입력/수정 기능 명확화 (v1.1)
- ERP 실행예산 사용자 직접 입력/수정
- RCMS budget_amount 사용자 직접 입력/수정
- 예산 수정 후 집계 재실행으로 반영

